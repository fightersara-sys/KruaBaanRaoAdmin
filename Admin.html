<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Admin Panel - ‡∏Ñ‡∏£‡∏±‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤</title>

<style>
  :root{
  --accent:#ff6600;
  --accent-2:#ff8800;
  --bg: #fffaf5;
  --dark:#202020;
  --panel:#2a2a2a;
}
body { font-family: Tahoma, sans-serif; margin:0; background:var(--bg); color:#222; }
header { background:var(--accent); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; position:fixed; left:230px; right:0; top:0; z-index:30; }
header h2 { margin:0; font-size:18px; }
header .right-actions { display:flex; gap:8px; align-items:center; }

/* Sidebar */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 230px;
  height: 100vh;
  background: var(--dark);
  color: #fff;
  padding-top: 18px;
  box-shadow: 2px 0 6px rgba(0,0,0,0.15);
  z-index:40;
  display:flex;
  flex-direction:column;
  align-items:stretch;
}
.brand {
  display:flex;
  gap:10px;
  align-items:center;
  padding: 14px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.brand img { width:38px; height:38px; object-fit:cover; border-radius:6px; }
.brand .title { font-weight:700; font-size:16px; line-height:1; }
.brand .sub { font-size:12px; color:rgba(255,255,255,0.7); margin-top:3px; }

.sidebar-menu { list-style:none; padding:12px 0; margin:0; flex:1; }
.sidebar-menu li { margin:6px 8px; }
.sidebar-menu a {
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  color:#fff;
  text-decoration:none;
  background:var(--panel);
  border-radius:8px;
  border-left:4px solid transparent;
  transition: all 0.15s ease;
  font-size:14px;
}
.sidebar-menu a:hover { transform: translateX(4px); background:#333; border-left:4px solid var(--accent); }

/* ====== ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ñ‡∏ß‡∏≠‡∏≠‡∏Å (active subtle) ====== */
.sidebar-menu a.active {
  background: var(--panel); /* ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ö‡∏™‡πâ‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß */
  color: #fff;
  border-left:4px solid var(--accent);
  box-shadow: none;
}

.sidebar-bottom { padding:12px 14px; border-top:1px solid rgba(255,255,255,0.03); font-size:13px; color:rgba(255,255,255,0.8); }

/* Main content */
.main-content { margin-left:230px; padding:84px 22px 32px 22px; min-height:100vh; box-sizing:border-box; }
.section { padding:6px 0; display:none; }
.section.active { display:block; }

.btn { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; color:white; }
.btn-add { background:#28a745; }
.btn-edit { background:#007bff; }
.btn-del { background:#dc3545; }
.btn-neutral { background:var(--accent-2); color:#fff; border: none; }

table { width:100%; border-collapse:collapse; margin-top:12px; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,0.05); }
thead th { background:var(--accent); color:white; padding:10px; text-align:center; font-weight:600; }
td, th { border-bottom:1px solid #eee; padding:10px; vertical-align:top; }
td img { max-width:80px; border-radius:6px; }

/* Modal */
.modal-bg {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.45);
justify-content: center;
align-items: center;
z-index: 200;
}
.modal {
  background: white;
  padding: 28px 32px;
  border-radius: 18px;
  width: 980px;
  max-width: 96vw;
  box-shadow: 0 22px 60px rgba(0,0,0,0.28);
  animation: popIn 0.18s ease;
}
.modal-content {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 36px;
}
.modal input,
.modal select,
.modal textarea {
  padding: 13px 15px;
  border-radius: 10px;
  border: 1px solid #ccc;
  width: 100%;
  margin-bottom: 14px;
  background: #fff;
  font-size: 15px;
}
.preview { width: 100%; height: 300px; object-fit: cover; border-radius: 14px; border: 1px solid #ddd; background: #f4f4f4; }

/* Option UI */
.opt-group { margin-bottom: 14px; border: 1px solid #dcdcdc; border-radius: 12px; overflow: hidden; background: white; transition: 0.22s; }
.opt-header { padding: 12px 16px; background: #f7f7f7; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
.opt-header-left { display: flex; align-items: center; gap: 10px; }
.opt-header-left input[type="checkbox"] { width: 18px; height: 18px; }
.opt-title { font-size: 15px; font-weight: 600; white-space: nowrap; }
.opt-arrow { transition: 0.25s; font-size: 18px; opacity: 0.6; }
.opt-group.active { border-color: var(--accent); }
.opt-group.active .opt-arrow { transform: rotate(180deg); }
.opt-options { padding: 12px 18px 10px; display: none; }
.opt-group.active .opt-options { display: block; }
.opt-item { display: flex; align-items: center; gap: 10px; padding: 6px 0; line-height: 1; width: 100%; }
.opt-item input[type="checkbox"] { width: 18px; height: 18px; flex-shrink: 0; }
.opt-item label, .opt-item span { font-size: 15px; white-space: nowrap; line-height: 1.2; flex-grow: 1; overflow: hidden; }
.opt-price { margin-left: auto; font-size: 15px; white-space: nowrap; flex-shrink: 0; }
.row { display:flex; gap:12px; align-items:center; }
.col { display:flex; flex-direction:column; gap:8px; }
.input-mini { width:140px; padding:8px 10px; border-radius:8px; border:1px solid #ccc; }
.card {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom:20px;
}
.input {
  padding: 10px;
  width: 100%;
  margin-bottom:12px;
  border-radius: 8px;
  border:1px solid #ccc;
}
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 32px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background: #e74c3c;
  border-radius: 999px;
  transition: .3s;
}

.slider:before {
  content: "";
  position: absolute;
  height: 26px;
  width: 26px;
  left: 3px;
  bottom: 3px;
  background: white;
  border-radius: 50%;
  transition: .3s;
}

input:checked + .slider {
  background: #2ecc71;
}

input:checked + .slider:before {
  transform: translateX(28px);
}
/* ===== Responsive Core ===== */
* {
  box-sizing: border-box;
}

body {
  -webkit-text-size-adjust: 100%;
}

img {
  max-width: 100%;
}

/* Card / Container */
.card,
.container,
.wrapper {
  max-width: 100%;
}

/* Buttons & inputs */
input, select, textarea, button {
  font-size: 16px; /* ‡∏Å‡∏±‡∏ô iOS zoom */
}

/* Mobile layout */
@media (max-width: 768px) {

  body {
    background:#f6f7fb;
  }

  .sidebar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 64px;
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: white;
    border-top: 1px solid #ddd;
    z-index: 999;
  }

  .sidebar a {
    flex: 1;
    text-align: center;
    font-size: 12px;
    padding: 6px 0;
  }

  main {
    padding-bottom: 80px;
  }

  .section {
    padding: 10px;
  }

  table {
    font-size: 12px;
  }

  .btn {
    padding: 10px 12px;
    font-size: 13px;
  }

  .card,
  .setting-card {
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 15px;
  }

  input, select, textarea {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border-radius: 10px;
  }

  .order-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
}
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" aria-label="Main sidebar">
  <div class="brand">
    <img id="brandLogo" src="https://vxutzcrwqbnkcwxtdphy.supabase.co/storage/v1/object/public/Logo/KruaBaanRao%20Logo.png" alt="logo">
    <div>
      <div id="brandTitle" class="title">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤</div>
      <div class="sub">Admin Panel</div>
    </div>
  </div>

  <ul class="sidebar-menu" role="menu">
    <li><a href="#" id="tab-dashboard" onclick="switchTab('dashboardSec'); return false;">üìä Dashboard</a></li>
    <li><a href="#" id="tab-order" onclick="switchTab('orderSec'); return false;">üßæ ‡∏Ñ‡∏¥‡∏ß Order</a></li>
    <li><a href="#" id="tab-menu" onclick="switchTab('menuSec'); return false;">üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</a></li>
    <li><a href="#" id="tab-opt" onclick="switchTab('optSec'); return false;">‚úÖÔ∏è ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</a></li>
    <li><a href="#" id="tab-settings" onclick="switchTab('settingsSec'); loadStoreSettings(); return false;">üè™ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô</a></li>
  </ul>

  <div class="sidebar-bottom">
    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="todayDate"></span>
  </div>
</aside>

<!-- Header -->
<header>
  <h2 id="pageTitle">Admin Panel - ‡∏Ñ‡∏£‡∏±‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤</h2>
  <div class="right-actions">
    <button onclick="logout()" class="btn" style="background:#ff0066;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</header>

<!-- Main: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á sections ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô main -->
<main class="main-content">

  <!-- DASHBOARD -->
  <div id="dashboardSec" class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Dashboard</h3>
    </div>

    <div style="margin-top:18px; display:flex; flex-direction:column; gap:20px;">

      <!-- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡πà‡∏ô -->
      <div style="background:#fff3e6; padding:18px; border-radius:10px; font-size:22px; font-weight:700; text-align:center; color:#ff6600;">
        üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="todaySales">0</span> ‡∏ö‡∏≤‡∏ó
      </div>

      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="date" id="dashFrom">
        <input type="date" id="dashTo">

        <button class="btn btn-neutral" onclick="loadDashboard()">‡∏î‡∏π</button>
      </div>

      <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ -->
      <div style="background:white; padding:20px; border-radius:12px;">
        <canvas id="salesChart" height="100"></canvas>
      </div>

      <div style="display:grid; grid-template-columns:1fr 340px; gap:20px;">
        
        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏° -->
        <div>
          <h4 style="margin-top:18px;">5 ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h4>
          <table id="topMenusTable">
            <thead><tr><th>‡πÄ‡∏°‡∏ô‡∏π</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Summary -->
        <div>
          <h4>‡∏™‡∏£‡∏∏‡∏õ</h4>
          <div id="dashboardSummary" style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
            <p>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <strong id="sumTotal">0</strong> ‡∏ö‡∏≤‡∏ó</p>
            <p>‡∏ö‡πâ‡∏≤‡∏ô/‡πÇ‡∏ï‡πä‡∏∞ ‡∏™‡∏±‡πà‡∏á‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î: <strong id="topHouse">-</strong></p>
            <p>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì): <strong id="topMeat">-</strong></p>
          </div>
        </div>

      </div> <!-- ‡∏õ‡∏¥‡∏î grid wrapper -->

    </div> <!-- ‡∏õ‡∏¥‡∏î content wrapper -->

  </div> <!-- ‡∏õ‡∏¥‡∏î dashboardSec ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -->

  <!-- Orders (‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô main) -->
  <div id="orderSec" class="section">
    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏Ñ‡∏¥‡∏ß</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏£‡∏ß‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="orderTable"></tbody>
    </table>
  </div>

  <!-- MENU -->
  <div id="menuSec" class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h3>
      <button class="btn btn-add" onclick="openMenuModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</button>
    </div>
    <table>
      <thead><tr><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏£‡∏π‡∏õ</th><th>‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
      <tbody id="menuTable"></tbody>
    </table>
  </div>

  <!-- OPTIONS -->
  <div id="optSec" class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Options)</h3>
      <button class="btn btn-add" onclick="openOptModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    </div>
    <table>
      <thead><tr><th>ID</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
      <tbody id="optTable"></tbody>
    </table>
  </div>

  <!-- STORE SETTINGS -->
  <div id="settingsSec" class="section">
    <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô</h3>

    <div class="setting-card">
  <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô</h3>

      <label class="switch">
        <input type="checkbox" id="shopOpenSwitch">
        <span class="slider"></span>
      </label>

      <span id="shopStatusText" style="margin-left:10px;font-weight:bold;"></span>
    </div>

    <div class="card">
      <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô</h4>

      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
      <input id="storeName" class="input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô">

      <label>Concept ‡∏£‡πâ‡∏≤‡∏ô</label>
      <textarea id="storeConcept" class="input" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢/‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡∏õ‡∏ï‡πå‡∏£‡πâ‡∏≤‡∏ô" 
          style="height:80px;"></textarea>

      <label>Line ID</label>
      <input id="storeLine" class="input" placeholder="Line ID">

      <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô</label>
      <input id="storeOpen" type="time" class="input">

      <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô</label>
      <input id="storeClose" type="time" class="input">

      <label>‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô</label>
      <input id="storeLogo" type="file" onchange="previewLogo(event)">
      <img id="logoPreview" style="width:140px; margin-top:10px; border-radius:10px;">

      <label>‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô</label>
      <input id="storeBG" type="file" onchange="previewBG(event)">
      <img id="bgPreview" style="width:220px; margin-top:10px; border-radius:10px;">

      <button class="btn btn-add" onclick="saveStoreSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô</button>
    </div>

    <div class="card" style="margin-top:30px;">
      <h4>QR Code ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h4>

      <input id="paymentQR" type="file" onchange="previewQR(event)">
      <img id="qrPreview" style="width:200px; margin-top:10px; border-radius:10px;">

      <button class="btn btn-add" onclick="saveQR()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å QR Code</button>
    </div>
  </div>

</main>

<!-- MODALS (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
<div id="menuModal" class="modal-bg" style="display:none;">
  <div class="modal">
    <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h3>
    <div class="modal-content">
      <!-- LEFT -->
      <div>
        <input id="mName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π">
        <input id="mPrice" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
        <input id="mCat" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)">
        <input id="mImage" type="file" onchange="handleImagePreview(event)">
        <div id="menuOptionGroupList"></div>
      </div>
      <!-- RIGHT (Image Preview) -->
      <div>
        <img id="previewImg" class="preview">
      </div>
    </div>
    <div class="btn-area" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn btn-add" onclick="saveMenu()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="btn btn-del" onclick="closeMenuModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<div id="optModal" class="modal-bg" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h3>
    <input id="oType" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡πÄ‡∏ä‡πà‡∏ô: ‡∏Ç‡∏ô‡∏≤‡∏î, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">
    <input id="oName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÄ‡∏ä‡πà‡∏ô: ‡πÉ‡∏´‡∏ç‡πà, ‡πÇ‡∏Ñ‡πâ‡∏Å">
    <input id="oPrice" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (0 ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ)">
    <div class="row" style="margin-top:12px;justify-content:flex-end;">
      <button class="btn btn-add" onclick="saveOption()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="btn btn-del" onclick="closeOptModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ---------------- Supabase client ---------------- */
const supabaseUrl = "https://vxutzcrwqbnkcwxtdphy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4dXR6Y3J3cWJua2N3eHRkcGh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzkzNDQsImV4cCI6MjA3NTA1NTM0NH0.zwbcu_4eGAiRTaX7QBwgrJhWgCda58FW-boeJM-ZlKg";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

/* ---------------- State ---------------- */
let editingMenuId = null;
let editingOptId = null;

async function loadBrandUI() {
  const { data, error } = await supabaseClient
    .from("store_settings")
    .select("*")
    .eq("id", 1)
    .single();

  if (!data) return;

  document.getElementById("brandTitle").innerText = data.store_name || "";
  document.getElementById("brandLogo").src = data.logo_url || "";

  // ‚≠ê ‡πÉ‡∏ä‡πâ background
  if (data.background_url) {
    document.body.style.backgroundImage = `url('${data.background_url}')`;
    document.body.style.backgroundSize = "cover";
  }

  // ‚≠ê ‡πÉ‡∏ä‡πâ concept
  const concept = document.getElementById("brandConcept");
  if (concept) concept.innerText = data.store_concept || "";
 }

/* ---------------- Utilities ---------------- */
function setActiveTab(tabId){
  document.querySelectorAll(".sidebar-menu a").forEach(a=>a.classList.remove("active"));
  const el = document.getElementById(tabId);
  if(el) el.classList.add("active");
}
function formatDateNow(){ const d = new Date(); return d.toLocaleDateString("th-TH"); }
document.getElementById("todayDate").innerText = formatDateNow();

/* ---------------- Store settings helpers ---------------- */
async function loadShopStatus() {
  const { data, error } = await supabaseClient
    .from("shop_settings")
    .select("id, is_open")
    .eq("id", 1)
    .maybeSingle();   // üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ row ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢
  if (!data) {
    const { error: insertError } = await supabaseClient
      .from("shop_settings")
      .insert({ id: 1, is_open: true });

    if (insertError) {
      console.error("Insert shop_settings failed:", insertError);
      return;
    }

    document.getElementById("shopOpenSwitch").checked = true;
    document.getElementById("shopStatusText").textContent = "üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
    return;
  }

  const sw = document.getElementById("shopOpenSwitch");
  const text = document.getElementById("shopStatusText");

  sw.checked = data.is_open;
  text.textContent = data.is_open ? "üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô" : "üî¥ ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
}

function bindShopSwitch() {
  const sw = document.getElementById("shopOpenSwitch");
  if (!sw) {
    console.error("shopOpenSwitch not found");
    return;
  }

  sw.onchange = async (e) => {
    const isOpen = e.target.checked;

    const { error } = await supabaseClient
      .from("shop_settings")
      .update({ is_open: isOpen })
      .eq("id", 1);

    if (error) {
      alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
      e.target.checked = !isOpen;
      return;
    }

    document.getElementById("shopStatusText").textContent =
      isOpen ? "üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô" : "üî¥ ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
  };
}

async function loadStoreSettings() {
  const { data, error } = await supabaseClient
    .from("store_settings")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) return;

  document.getElementById("storeName").value = data.store_name || "";
  document.getElementById("storeLine").value = data.line_id || "";
  document.getElementById("storeOpen").value = data.open_time || "";
  document.getElementById("storeClose").value = data.close_time || "";
  document.getElementById("storeConcept").value = data.store_concept || "";
  
  if (data.store_background)
    document.getElementById("bgPreview").src = data.store_background;

  if (data.logo_url)
    document.getElementById("logoPreview").src = data.logo_url;

  if (data.qr_url)
    document.getElementById("qrPreview").src = data.qr_url;

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏•‡πÇ‡∏Å‡πâ + ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
  if (data.logo_url) document.getElementById("brandLogo").src = data.logo_url;
  if (data.store_name) document.getElementById("brandTitle").innerText = data.store_name;
}

async function uploadLogo(file) {
  if (!file) return null;

  const bucket = "Logo";
  const fileName = "logo.png"; // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏°‡∏≠

  // 1. ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  const { error: removeError } = await supabaseClient.storage
    .from(bucket)
    .remove([fileName]);

  if (removeError) {
    console.warn("Remove old logo error:", removeError.message);
  }

  // 2. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ó‡∏±‡∏ö‡πÑ‡∏î‡πâ)
  const { data, error: uploadError } = await supabaseClient.storage
    .from(bucket)
    .upload(fileName, file, {
      cacheControl: "3600",
      upsert: true
    });

  if (uploadError) {
    console.error("Upload Logo Error:", uploadError);
    alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + uploadError.message);
    return null;
  }

  // 3. ‡∏î‡∏∂‡∏á public URL
  const { data: urlData } = supabaseClient.storage
    .from(bucket)
    .getPublicUrl(fileName);

  return urlData.publicUrl + "?v=" + Date.now();
}

async function uploadBackground(file) {
  console.log("BG FILE >>>", file);

  if (!file) return null;

  const bucket = "other-image";
  const filePath = "background.jpg";

  // ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤
  await supabaseClient.storage.from(bucket).remove([filePath]);

  // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
  const { data, error } = await supabaseClient.storage
    .from(bucket)
    .upload(filePath, file, {
      upsert: true,
      contentType: file.type
    });

  console.log("BG UPLOAD DATA:", data);
  console.log("BG UPLOAD ERROR:", error);

  if (error) {
    alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
    return null;
  }

  const { data: urlData } = supabaseClient.storage
    .from(bucket)
    .getPublicUrl(filePath);

  const backgroundURL = urlData.publicUrl + "?v=" + Date.now();
  return backgroundURL;
}


function previewLogo(e) {
  const file = e.target.files[0];
  if (file) document.getElementById("logoPreview").src = URL.createObjectURL(file);
}

function previewQR(e) {
  const file = e.target.files[0];
  if (file) document.getElementById("qrPreview").src = URL.createObjectURL(file);
}

function previewBG(e) {
  const file = e.target.files[0];
  if (file) document.getElementById("bgPreview").src = URL.createObjectURL(file);
}

async function saveStoreSettings() {
  const name = document.getElementById("storeName").value;
  const concept = document.getElementById("storeConcept").value;
  const line = document.getElementById("storeLine").value;
  const open = document.getElementById("storeOpen").value;
  const close = document.getElementById("storeClose").value;

  const logoFile = document.getElementById("storeLogo").files[0];
  const bgFile   = document.getElementById("storeBG").files[0];
  const qrFile = document.getElementById("paymentQR").files[0];

  let logoURL = null;
  let backgroundURL = null;
  let qrURL = null;

  if (logoFile) logoURL = await uploadLogo(logoFile);
  if (bgFile)   backgroundURL = await uploadBackground(bgFile);
  if (qrFile) qrURL = await uploadQR(qrFile);

  console.log("=== FINAL backgroundURL ===", backgroundURL);

  const updateData = {
    store_name: name,
    store_concept: concept,
    line_id: line,
    open_time: open,
    close_time: close,
  };

  if (logoURL) updateData.logo_url = logoURL;
  if (backgroundURL) updateData.store_background = backgroundURL;
  if (qrURL) updateData.qr_url = qrURL;

  console.log("UPDATE DATA >>>", updateData);

  const { error } = await supabaseClient
    .from("store_settings")
    .update(updateData)
    .eq("id", 1);

  if (error) {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
    return;
  }

  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  loadStoreSettings();
}


async function uploadQR(file) {
  if (!file) return null;

  const fileName = "qr.png";

  // 1. ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå qr/
  await supabaseClient.storage
  .from("payment-qr")
  .remove(["qr.png"]);

  // 2. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°
  const { error } = await supabaseClient.storage
  .from("payment-qr")
  .upload("qr.png", file, { upsert: true });

  if (error) {
    alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î QR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
    return null;
  }

  // 3. ‡∏î‡∏∂‡∏á Public URL
  const { data } = supabaseClient.storage
  .from("payment-qr")
  .getPublicUrl("qr.png");

return data.publicUrl + "?v=" + Date.now();
}


async function saveQR() {
  const file = document.getElementById("paymentQR").files[0];
  if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û");

  const qrURL = await uploadQR(file);
  if (!qrURL) return;

  const { error } = await supabaseClient
    .from("store_settings")
    .update({ qr_url: qrURL })
    .eq("id", 1);

  if (error) {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å QR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
    return;
  }

  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å QR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  loadStoreSettings();
}

/* ------------------- XSS Safe Escape Function ------------------- */
function escapeHtml(text) {
  if (typeof text !== "string") return text;
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/* ----------------------------------------------------
   Queue system: getNextQueueNumber + assign
---------------------------------------------------- */
async function getNextQueueNumber() {
  try {
    // get today's range in ISO (server-side would be better; this is safe)
    const todayStart = new Date();
    todayStart.setHours(0,0,0,0);
    const todayEnd = new Date(todayStart);
    todayEnd.setDate(todayEnd.getDate() + 1);

    const fromISO = todayStart.toISOString();
    const toISO = todayEnd.toISOString();

    const { data, error } = await supabaseClient
      .from('orders')
      .select('max(queue_number)')
      .gte('created_at', fromISO)
      .lt('created_at', toISO)
      .neq('status', '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß');

    if (error) { console.error("getNextQueueNumber err:", error); return 1; }
    const maxQ = (data && data[0] && data[0].max) ? Number(data[0].max) : 0;
    return maxQ + 1;
  } catch (e) {
    console.error(e);
    return 1;
  }
}

async function assignQueueIfMissing(orderId, queueNumber) {
  try {
    const { error } = await supabaseClient
      .from("orders")
      .update({ queue_number: queueNumber })
      .eq("id", orderId);
    if (error) {
      console.error("assignQueueIfMissing", error);
      return false;
    }
    return true;
  } catch (e) { console.error(e); return false; }
}

window.optionMap = {};

/* ===============================
   Helper: parse items (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô order-status)
================================ */
function parseOrderItems(itemsRaw, optionMap = {}) {
  if (typeof itemsRaw === "string") {
    try {
      itemsRaw = JSON.parse(itemsRaw);
    } catch {
      itemsRaw = [];
    }
  }

  if (!Array.isArray(itemsRaw)) return [];

  return itemsRaw.map(it => {
    const options = Array.isArray(it.options)
  ? it.options.map(o => {
      const opt = optionMap[o.id];
      return opt
        ? { name: opt.name, price: opt.price }
        : { name: "(‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß)", price: 0 };
    })
  : [];

    return {
      qty: it.qty || 1,
      food: it.food || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π",
      note: it.note || "",
      price: Number(it.price || 0),
      options
    };
  });
}

/* ===============================
   Load option map (Admin)
================================ */
async function loadOptionMap() {
  const { data, error } = await supabaseClient
    .from("options")
    .select("id, name, price");

  if (error) {
    console.error("‡πÇ‡∏´‡∏•‡∏î options ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", error);
    return;
  }

  window.optionMap = {};
  (data || []).forEach(o => {
    window.optionMap[o.id] = {
      name: o.name,
      price: Number(o.price || 0)
    };
  });

  console.log("optionMap loaded:", window.optionMap);
}

/* ---------------- Orders ---------------- */
async function loadOrders() {
 try { 
  let { data: orders, error } = await supabaseClient
  .from("orders")
  .select("id, house, queue_number, items, total, status, payment_method, payment_slip, created_at, delivery_image")
  .order("id", { ascending: false })
  .limit(1000);

    if (error) throw error;
    orders = orders || [];

    const missing = orders.filter(o => o.queue_number === null || o.queue_number === undefined || Number(o.queue_number) === 0);
if (missing.length > 0) {
  console.log("Found missing queue numbers:", missing.length);
  // If small number, you could assign; otherwise call RPC/batch update.
  if (missing.length <= 5) {
    // small safety path: assign locally but still rate-limited
    let nextQ = await getNextQueueNumber();
    for (const ord of missing) {
      try {
        await assignQueueIfMissing(ord.id, nextQ);
        nextQ++;
      } catch (e) { console.error("assign error", e); }
    }
  } else {
    // large: call server-side RPC to assign all missing in one request
    try {
      // create this RPC in DB named 'assign_missing_queue' (SQL provided below)
      await supabaseClient.rpc('assign_missing_queue');
    } catch (e) {
      console.error("RPC assign_missing_queue failed:", e);
    }
  }
  // refresh once
  const { data: refreshed, error: rerr } = await supabaseClient
    .from("orders")
    .select("id, house, queue_number, items, total, status, payment_method, payment_slip, created_at, delivery_image")
    .order("id", { ascending: false })
    .limit(1000);
  if (!rerr) orders = refreshed || orders;
}

    renderOrders(orders);
  } catch (e) {
    console.error("loadOrders error", e);
    throw e;
  }
}

function isSafeUrl(url) {
  try {
    const u = new URL(url, window.location.origin);
    // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ http(s)
    return u.protocol === 'http:' || u.protocol === 'https:';
  } catch (e) {
    return false;
  }
}

function renderOrders(data) {
  const tbody = document.getElementById("orderTable");
  if (!tbody) return;
  tbody.innerHTML = "";

  data.forEach(o => {

    console.log("cash:", o.cash_paid, o.cash_change);


    /* üî¥ (1) ‡∏™‡∏£‡πâ‡∏≤‡∏á tr ‡∏Å‡πà‡∏≠‡∏ô */
    const tr = document.createElement("tr");

    /* ID */
    const tdId = document.createElement("td");
    tdId.textContent = o.id;
    tr.appendChild(tdId);

    /* ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà */
    const tdHouse = document.createElement("td");
    tdHouse.textContent = o.house || "-";
    tr.appendChild(tdHouse);

    /* ‡∏Ñ‡∏¥‡∏ß */
    const tdQueue = document.createElement("td");
    tdQueue.textContent = o.queue_number || "-";
    tr.appendChild(tdQueue);

    /* =========================
       üî• ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
    ========================= */
    const tdItems = document.createElement("td");
    tdItems.style.minWidth = "260px";

    const items = parseOrderItems(o.items, window.optionMap || {});
    console.log("parsed items:", items);

    const itemsHtml = items.map(it => {
  const basePrice = Number(it.price || 0);
  let optionTotal = 0;


const opts = it.options.length
  ? it.options.map(opt => {
      const name = opt?.name || "(‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß)";
      const price = Number(opt?.price || 0);

      optionTotal += price;

      return `
        <div>
          - ${escapeHtml(name)}
          ${price > 0 ? `<span style="color:#ff0000;"> +${price}</span>` : ""}
        </div>
      `;
    }).join("")
  : `<div>- ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</div>`;

  const note = it.note
    ? `<div style="font-size:12px;color:#999;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${escapeHtml(it.note)}</div>`
    : "";

  const itemTotal = (basePrice + optionTotal) * (it.qty || 1);

  return `
    <div style="margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;">
        <strong>${it.qty} √ó ${escapeHtml(it.food)}</strong>
      </div>

      <div style="font-size:12px;color:#555;margin-left:12px;">
        ${opts}
      </div>

      ${note}

      <div style="font-size:12px;color:#333;margin-left:12px;">
        ‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ = <strong>${itemTotal}</strong> ‡∏ö‡∏≤‡∏ó
      </div>
    </div>
  `;
}).join("");

    tdItems.innerHTML = itemsHtml || "<div style='color:#777'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>";
    tr.appendChild(tdItems);

    // Total
    const tdTotal = document.createElement("td");
    tdTotal.style.width = "110px";
    tdTotal.textContent = `${Number(o.total || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
    tr.appendChild(tdTotal);

    // Status cell (‡∏°‡∏µ id ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
    const tdStatus = document.createElement("td");
    tdStatus.id = `order-status-${o.id}`;
    tdStatus.style.width = "120px";
    tdStatus.textContent = o.status || "-";
    tr.appendChild(tdStatus);

    // Payment info (‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ eventListener)
    const tdPay = document.createElement("td");
    tdPay.style.width = "120px";
    if (o.payment_method === "QR" && o.payment_slip && isSafeUrl(o.payment_slip)) {
      const btn = document.createElement("button");
      btn.className = 'btn btn-neutral';
      btn.type = 'button';
      btn.textContent = '‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ';
      // ‡∏ú‡∏π‡∏Å event ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏±‡∏á onclick ‡∏î‡πâ‡∏ß‡∏¢ string
      btn.addEventListener('click', () => viewSlip(o.payment_slip));
      tdPay.appendChild(btn);
    } else if (o.payment_method === "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î") {

  const paid = Number(o.cash_paid || 0);
  const change = Number(o.cash_change || 0);

  tdPay.innerHTML = `
    <div>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div>
    ${paid > 0 ? `<div style="font-size:12px;color:#555;">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô: ${paid.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>` : ""}
    ${paid > 0 ? `<div style="font-size:12px;color:#d32f2f;">‡∏ó‡∏≠‡∏ô: ${change.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>` : ""}
  `;
} else {
      tdPay.textContent = "-";
    }
    tr.appendChild(tdPay);

    // created_at (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
    const tdCreated = document.createElement("td");
    tdCreated.style.whiteSpace = "nowrap";
    tdCreated.style.width = "160px";
    tdCreated.textContent = o.created_at
      ? new Date(o.created_at).toLocaleString("th-TH", { timeZone: "Asia/Bangkok" })
      : "-";
    tr.appendChild(tdCreated);

    // Action buttons (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ inline onclick ‚Äî ‡πÉ‡∏ä‡πâ addEventListener)
    const tdActions = document.createElement("td");
    tdActions.style.whiteSpace = "nowrap";

    const btnAccept = document.createElement("button");
    btnAccept.className = "btn btn-neutral";
    btnAccept.type = 'button';
    btnAccept.textContent = "‡∏£‡∏±‡∏ö";
    btnAccept.addEventListener("click", () => updateStatus(o.id, '‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå'));
    tdActions.appendChild(btnAccept);

    const btnMake = document.createElement("button");
    btnMake.className = "btn btn-edit";
    btnMake.type = 'button';
    btnMake.textContent = "‡∏ó‡∏≥";
    btnMake.addEventListener("click", () => updateStatus(o.id, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£'));
    tdActions.appendChild(btnMake);

    const btnDeliver = document.createElement("button");
    btnDeliver.className = "btn btn-add";
    btnDeliver.type = 'button';
    btnDeliver.textContent = "‡∏™‡πà‡∏á";
    btnDeliver.addEventListener("click", () => updateStatus(o.id, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'));
    tdActions.appendChild(btnDeliver);

    const btnDone = document.createElement("button");
    btnDone.className = "btn btn-del";
    btnDone.type = 'button';
    btnDone.textContent = "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß";
    btnDone.addEventListener("click", () => sendDone(o.id));
    tdActions.appendChild(btnDone);

    tr.appendChild(tdActions);

    tbody.appendChild(tr);
  });
}

/* ---------------- Re-run queue (reindex) ---------------- */
async function rerunAllQueue() {
  try {
    // Simple server-side reindex RPC (recommended) or do in-client with single SQL:
    const { data, error } = await supabaseClient.rpc('rerun_all_queue');
    if (error) { console.error("rerunAllQueue rpc error:", error); alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ"); return; }
    await loadOrders();
    alert("‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  } catch (e) { console.error(e); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß"); }
}

function renderStatusIcon(status) {
  if (status === "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß") {
    return `<span style="color:green;font-size:20px;">‚úî</span>`;
  }
  return status || "-";
}

/* ---------------- Update status ---------------- */
async function updateStatus(orderId, newStatus) {
  try {
    const { data, error } = await supabaseClient
      .from('orders')
      .update({ status: newStatus })
      .eq('id', orderId);

    if (error) { console.error("updateStatus error:", error); alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); return; }

    if (newStatus === "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß") {
      // run server-side reindex RPC (single call)
      await supabaseClient.rpc('rerun_all_queue');
    }

    // Update UI locally for responsiveness ‚Äî do not force full reload; schedule debounced reload
    const statusTd = document.getElementById(`order-status-${orderId}`);
    if(statusTd) statusTd.innerText = newStatus;
    scheduleOrdersReload(500);
  } catch (err) { console.error(err); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
}

/* ---------------- Upload delivery image when marking done ---------------- */
async function sendDone(id){
  const fileInput = document.createElement("input");
  fileInput.type="file"; fileInput.accept="image/*";
  fileInput.onchange=async()=>{
    const file=fileInput.files[0];
    if(!file) return;
    const fileName=`delivery_${Date.now()}_${file.name}`.replace(/\s+/g,'_');
    const { error } = await supabaseClient.storage.from("delivery-images").upload(fileName, file);
    if(error) return alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (error.message||error));
    const { data } = supabaseClient.storage.from("delivery-images").getPublicUrl(fileName);
    const imgUrl = data.publicUrl;
   await supabaseClient
  .from("orders")
  .update({
    status:"‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß",
    delivery_image: imgUrl,
    queue_number: null
  })
  .eq("id", id);

// call RPC once
  await supabaseClient.rpc('rerun_all_queue');
  scheduleOrdersReload(500);
  
  };
  fileInput.click();
}

/* ---------------- Real-time subscription ---------------- */
let realtimeReloadTimer = null;
function scheduleOrdersReload(delay = 700) {
  if (realtimeReloadTimer) clearTimeout(realtimeReloadTimer);
  realtimeReloadTimer = setTimeout(()=> { loadOrders().catch(e=>console.error(e)); realtimeReloadTimer = null; }, delay);
}

let channelRef = null;
function subscribeRealtime(){
  if (channelRef) return;
  channelRef = supabaseClient.channel("orders")
    .on("postgres_changes", { event:"INSERT", schema:"public", table:"orders" }, payload => {
      playSound();
      // For INSERT we can optimistically fetch only the new row or schedule a reload
      scheduleOrdersReload(500);
    })
    .on("postgres_changes", { event:"UPDATE", schema:"public", table:"orders" }, payload => {
      // Only schedule reload ‚Äî do not reload immediately on every update
      scheduleOrdersReload(700);
    })
    .subscribe();
  }
  window.addEventListener('beforeunload', () => {
  try { if(channelRef) channelRef.unsubscribe(); } catch(e){}
});

function playSound(){
  const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  audio.play().catch(err=>{ console.log("Autoplay blocked"); });
}

/* ---------------- View slip modal ---------------- */
function viewSlip(url){
  if(!isSafeUrl(url)) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ ‡∏´‡∏£‡∏∑‡∏≠ URL ‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢");
    return;
  }
  const bg = document.createElement("div");
  bg.id = "__slip_bg";
  bg.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999;";
  bg.innerHTML = `
    <div style="background:white;padding:10px;border-radius:8px;max-width:95vw;" id="__slip_box">
      <img src="${escapeHtml(url)}" style="max-width:90vw;max-height:80vh;border-radius:8px;">
      <div style="text-align:center;margin-top:6px;">
        <button id="__close_slip_btn">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>`;
  document.body.appendChild(bg);
  document.getElementById("__close_slip_btn").onclick = ()=> { const el = document.getElementById("__slip_bg"); if(el) el.remove(); };
}

/* ---------------- Menus & Options (‡πÅ‡∏Å‡πâ saveMenu bug) ---------------- */
async function loadMenus(){
  try{
    const { data, error } = await supabaseClient.from("menus").select("*").order("id");
    if(error) throw error;
    const tbody=document.getElementById("menuTable"); if(!tbody) return; tbody.innerHTML="";
    (data||[]).forEach(m=>{
      const row=document.createElement("tr");
      row.innerHTML = `
        <td style="width:60px;">${m.id}</td>
        <td style="text-align:left">${m.name}</td>
        <td style="width:90px">${m.price}</td>
        <td style="width:120px">${m.category || "-"}</td>
        <td>${m.image_url ? `<img src="${m.image_url}" width="80">` : "-"}</td>
        <td style="width:90px"><input type="checkbox" ${m.visible ? "checked" : ""} onchange="toggleVisible('menus',${m.id},this.checked)"></td>
        <td style="white-space:nowrap;">
          <button class="btn btn-edit" onclick="openMenuModal(${m.id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn btn-del" onclick="deleteItem('menus',${m.id})">‡∏•‡∏ö</button>
        </td>`;
      tbody.appendChild(row);
    });
  }catch(e){ console.error("loadMenus err", e); }
}

async function loadOptions(){
  try{
    const { data, error }=await supabaseClient.from("options").select("*").order("id");
    if(error) throw error;
    const tbody=document.getElementById("optTable"); if(!tbody) return; tbody.innerHTML="";
    (data||[]).forEach(o=>{
      const row=document.createElement("tr");
      row.innerHTML=`
        <td style="width:60px;">${o.id}</td><td style="text-align:left">${o.type}</td><td style="text-align:left">${o.name}</td><td style="width:90px">${o.price}</td>
        <td style="width:90px"><input type="checkbox" ${o.visible?"checked":""} onchange="toggleVisible('options',${o.id},this.checked)"></td>
        <td style="white-space:nowrap;">
          <button class="btn btn-edit" onclick="openOptModal(${o.id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn btn-del" onclick="deleteItem('options',${o.id})">‡∏•‡∏ö</button>
        </td>`;
      tbody.appendChild(row);
    });
  }catch(e){ console.error("loadOptions err", e); }
}

/* ==== Option Groups + Options Rendering ==== */
async function loadOptionGroups(){
const { data, error } = await supabaseClient.from("option_groups").select("id,name,visible").order("id");
return error ? [] : data;
}
async function loadOptionsByGroup(gid){
const { data } = await supabaseClient.from("options").select("id,name,price,visible").eq("group_id",gid).order("id");
return data || [];
}
async function loadMenuSelectedGroups(mid){
const { data } = await supabaseClient.from("menu_option_groups").select("group_id").eq("menu_id",mid);
return data ? data.map(x=>x.group_id) : [];
}
async function loadMenuSelectedOptions(mid){
const { data } = await supabaseClient.from("menu_options").select("option_id").eq("menu_id",mid);
return data ? data.map(x=>x.option_id) : [];
}
async function renderMenuOptionPanel(menuId=null){
  const groups = await loadOptionGroups();
  const selectedGroups = menuId ? await loadMenuSelectedGroups(menuId) : [];
  const selectedOptions = menuId ? await loadMenuSelectedOptions(menuId) : [];

  const container = document.getElementById("menuOptionGroupList");
  container.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°

  for (const g of groups) {
    // parent group container
    const groupDiv = document.createElement("div");
    groupDiv.className = "opt-group";
    groupDiv.dataset.groupId = g.id;

    // header (checkbox + title + arrow)
    const header = document.createElement("div");
    header.className = "opt-header";
    header.style.display = "flex";
    header.style.alignItems = "center";
    header.style.justifyContent = "space-between";
    header.style.padding = "8px";
    header.style.cursor = "pointer";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.alignItems = "center";
    left.style.gap = "10px";

    const groupChk = document.createElement("input");
    groupChk.type = "checkbox";
    groupChk.className = "mog";
    groupChk.value = g.id;
    if (selectedGroups.includes(g.id)) groupChk.checked = true;

    // keep same class name for saving logic (saveMenuOptionGroups uses '.mog')
    const title = document.createElement("div");
    title.textContent = g.name;
    title.className = "opt-title";
    title.style.fontWeight = "600";

    left.appendChild(groupChk);
    left.appendChild(title);

    const arrow = document.createElement("div");
    arrow.className = "opt-arrow";
    arrow.textContent = "‚ñæ";
    arrow.style.transition = "0.2s";

    header.appendChild(left);
    header.appendChild(arrow);

    // options list (inner body) - will populate from DB
    const optionsBox = document.createElement("div");
    optionsBox.className = "opt-options";
    optionsBox.style.marginTop = "8px";
    optionsBox.style.paddingLeft = "10px";
    optionsBox.style.display = selectedGroups.includes(g.id) ? "block" : "none";

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å header (‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô checkbox) ‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏ö/‡∏Å‡∏≤‡∏á
    header.addEventListener("click", (ev) => {
      if (ev.target === groupChk) return; // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏ó‡∏µ‡πà checkbox ‡∏≠‡∏¢‡πà‡∏≤ toggle
      const isOpen = optionsBox.style.display === "block";
      optionsBox.style.display = isOpen ? "none" : "block";
      arrow.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
    });

    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î checkbox group ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô optionsBox
    groupChk.addEventListener("change", () => {
      optionsBox.style.display = groupChk.checked ? "block" : "none";
      arrow.style.transform = groupChk.checked ? "rotate(180deg)" : "rotate(0deg)";
    });

    // ‡πÇ‡∏´‡∏•‡∏î options ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å DB ‡πÅ‡∏•‡πâ‡∏ß render
    (async () => {
      const opts = await loadOptionsByGroup(g.id);
      optionsBox.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô
      opts.forEach(o => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.justifyContent = "space-between";
        row.style.alignItems = "center";
        row.style.padding = "6px 4px";
        row.style.fontSize = "14px";

        const leftRow = document.createElement("label");
        leftRow.style.display = "flex";
        leftRow.style.alignItems = "center";
        leftRow.style.gap = "8px";
        leftRow.style.cursor = "pointer";

        const optChk = document.createElement("input");
        optChk.type = "checkbox";
        optChk.className = "mo"; // ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö saveMenuOptions ‡∏ó‡∏µ‡πà‡∏´‡∏≤ '.mo'
        optChk.dataset.group = g.id;
        optChk.value = o.id;
        if (selectedOptions.includes(o.id)) optChk.checked = true;

        const optName = document.createElement("span");
        optName.textContent = o.name;

        leftRow.appendChild(optChk);
        leftRow.appendChild(optName);

        const priceSpan = document.createElement("span");
        priceSpan.style.opacity = "0.75";
        priceSpan.textContent = (o.price && Number(o.price) !== 0) ? `‡∏ø${o.price}` : "";

        row.appendChild(leftRow);
        row.appendChild(priceSpan);

        optionsBox.appendChild(row);
      });
    })();

    // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
    groupDiv.appendChild(header);
    groupDiv.appendChild(optionsBox);
    container.appendChild(groupDiv);
  }
}

async function saveMenuOptionGroups(menuId){
   await supabaseClient.from('menu_option_groups').delete().eq('menu_id',menuId);
   const checks=[...document.querySelectorAll('.mog:checked')];
   for(const c of checks){ await supabaseClient.from('menu_option_groups').insert({menu_id:menuId,group_id:Number(c.value)}); }
}
async function saveMenuOptions(menuId){
   await supabaseClient.from('menu_options').delete().eq('menu_id',menuId);
   const checks=[...document.querySelectorAll('.mo:checked')];
   for(const c of checks){ await supabaseClient.from('menu_options').insert({menu_id:menuId,option_id:Number(c.value)}); }
}
function toggleOptGroup(el) {
  const box = el.parentElement;
  box.classList.toggle("active");
}

/* ---------------- Menu modal ---------------- */
function openMenuModal(id=null){
  editingMenuId = id;
  document.getElementById("menuModal").style.display = "flex";

  renderMenuOptionPanel(id);

  if(id){
    supabaseClient.from("menus").select("*").eq("id",id).single().then(({data,error})=>{
      if(error){ console.error("openMenuModal fetch err", error); return; }
      if(data){
        document.getElementById("mName").value = data.name || "";
        document.getElementById("mPrice").value = data.price || "";
        document.getElementById("mCat").value = data.category || "";
        document.getElementById("previewImg").src = data.image_url || "";
      }
    }).catch(e=>console.error(e));
  } else {
    document.getElementById("mName").value="";
    document.getElementById("mPrice").value="";
    document.getElementById("mCat").value="";
    document.getElementById("mImage").value="";
    document.getElementById("previewImg").src="";
  }
}

function closeMenuModal(){ editingMenuId=null; document.getElementById("menuModal").style.display="none"; }

async function uploadImage(file) {
  if(!file) return "";
  const timeStamp = Date.now();
  const extension = file.name.split('.').pop();
  const safeFileName = `img_${timeStamp}.${extension.toLowerCase()}`;
  const filePath = `public/${safeFileName}`;
  const { error } = await supabaseClient.storage
    .from("menu-images")
    .upload(filePath, file, { cacheControl: "3600", upsert: false, contentType: file.type });
  if (error) {
    console.error("Upload error:", error);
    throw error;
  }
  const { data } = supabaseClient.storage.from("menu-images").getPublicUrl(filePath);
  return data.publicUrl;
}

function handleImagePreview(e){
  const file = e.target.files?.[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  document.getElementById("previewImg").src = url;
}

async function saveMenu(){
  const name = document.getElementById("mName").value.trim();
  const price = Number(document.getElementById("mPrice").value);
  const category = document.getElementById("mCat").value.trim();
  const file = document.getElementById("mImage").files[0];
  if(!name || isNaN(price)){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }
  let image_url = document.getElementById("previewImg").src || "";
  try{ if(file) image_url = await uploadImage(file); }catch(e){ alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e.message||e)); return; }
  if(editingMenuId){
    const { error } = await supabaseClient.from("menus").update({ name, price, category, image_url }).eq("id", editingMenuId);
    if(error){ alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (error.message||JSON.stringify(error))); return; }
    alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
  }else{
    const { error } = await supabaseClient.from("menus").insert({ name, price, category, image_url, visible:true });
    if(error){ alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (error.message||JSON.stringify(error))); return; }
    alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
  }
  closeMenuModal();
  loadMenus();
}

/* ---------------- Options modal ---------------- */
function openOptModal(id=null){
  editingOptId = id;
  document.getElementById("optModal").style.display = "flex";

  // reset inputs first
  document.getElementById("oType").value = "";
  document.getElementById("oName").value = "";
  document.getElementById("oPrice").value = 0;

  if(id){
    supabaseClient.from("options").select("*").eq("id",id).single().then(({data,error})=>{
      if(error){ console.error("openOptModal fetch err", error); return; }
      if(data){
        document.getElementById("oType").value = data.type || "";
        document.getElementById("oName").value = data.name || "";
        document.getElementById("oPrice").value = data.price || 0;
      }
    }).catch(e=>console.error(e));
  }
}

async function saveOption(){
  const type=document.getElementById("oType").value.trim();
  const name=document.getElementById("oName").value.trim();
  const price=Number(document.getElementById("oPrice").value);
  if(!type||!name){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }
  if (editingOptId) {
    const { error } = await supabaseClient.from("options").update({ type, name, price }).eq("id", editingOptId);
    if (error) { alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (error.message || JSON.stringify(error))); return; }
    alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  } else {
    const { error } = await supabaseClient.from("options").insert({ type, name, price });
    if (error) { alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (error.message || JSON.stringify(error))); return; }
    alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }

  editingOptId = null;
  closeOptModal();
  loadOptions();
}

function closeOptModal(){ editingOptId = null; document.getElementById("optModal").style.display = "none"; }

/* ---------------- Common ---------------- */
async function deleteItem(table,id){
  if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;
  const { error } = await supabaseClient.from(table).delete().eq("id",id);
  if(error){ alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (error.message||JSON.stringify(error))); return; }

  // clear & reload specific section after delete
  if(table === "menus") {
    await loadMenus();
    return;
  }
  if(table === "options") {
    await loadOptions();
    return;
  }
  // otherwise refresh orders
  await loadOrders();
}


async function toggleVisible(table,id,state){
  const { error } = await supabaseClient.from(table).update({visible:state}).eq("id",id);
  if(error) console.error("toggleVisible error", error);
}

function updatePageTitle(title) {
  document.getElementById("pageTitle").innerText = title;
}

function logout(){
  try { supabaseClient.auth.signOut(); } catch(e){}
  window.location.href = "index.html";
}

/* ---------------- Dashboard: load data and aggregate ---------------- */

let salesChart = null;

/* --- ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà renderSalesChart ‡πÄ‡∏î‡∏¥‡∏° --- */
function renderSalesChart(labels, data) {
  try {
    const canvas = document.getElementById("salesChart");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    if (salesChart) salesChart.destroy();

    salesChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)",
          data: data,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  } catch (err) {
    console.error("renderSalesChart error:", err);
  }
}

function applyRangeType(){
  const type = document.getElementById('dashRangeType').value;
  const fromEl = document.getElementById('dashFrom');
  const toEl = document.getElementById('dashTo');

  const now = new Date();
  let from, to;

  if(type === "today"){
    from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    to = new Date();
  }
  else if(type === "7days"){
    to = new Date();
    from = new Date();
    from.setDate(from.getDate() - 6);
  }
  else if(type === "month"){
    from = new Date(now.getFullYear(), now.getMonth(), 1);
    to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  }
  else if(type === "year"){
    from = new Date(now.getFullYear(), 0, 1);
    to = new Date(now.getFullYear(), 11, 31);
  }
  else {
    return;
  }

  fromEl.value = from.toISOString().slice(0,10);
  toEl.value = to.toISOString().slice(0,10);

  loadDashboard();
}

/* --- ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà loadDashboard ‡πÄ‡∏î‡∏¥‡∏° --- */
async function loadDashboard(){
  try{
    const from = document.getElementById('dashFrom').value;
    const to = document.getElementById('dashTo').value;

    if(!from || !to){ alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }

    // ‡πÉ‡∏ä‡πâ ISO boundaries ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    const fromISO = new Date(from + 'T00:00:00').toISOString();
    const toISO = new Date(new Date(to + 'T23:59:59')).toISOString();

    const { data: orders, error } = await supabaseClient
      .from('orders')
      .select('*')
      .gte('created_at', fromISO)
      .lte('created_at', toISO)
      .order('created_at', { ascending: true });

    if(error){ 
      console.error("loadDashboard orders err", error); 
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ"); 
      return; 
    }

    const ords = orders || [];

    /* ---------------- aggregate (‡πÉ‡∏ä‡πâ ISO date keys ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£) ---------------- */
    const salesByDay = {}; // key = YYYY-MM-DD (ISO date)
    let totalSum = 0;
    let todayTotal = 0;

    const menuCount = {};
    const houseCount = {};
    const meatKeywords = ['‡∏´‡∏°‡∏π','‡πÑ‡∏Å‡πà','‡πÄ‡∏ô‡∏∑‡πâ‡∏≠','‡∏õ‡∏•‡∏≤','‡∏Å‡∏∏‡πâ‡∏á','‡∏Å‡∏ö','‡πÄ‡∏õ‡πá‡∏î','‡∏•‡∏π‡∏Å‡∏ä‡∏¥‡πâ‡∏ô'];
    const meatCount = {};

    const todayKey = (new Date()).toISOString().slice(0,10); // YYYY-MM-DD

    ords.forEach(o => {
      try{
        // ‡πÅ‡∏õ‡∏•‡∏á created_at ‡πÄ‡∏õ‡πá‡∏ô ISO date key (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ toLocaleDateString)
        const created = o.created_at ? new Date(o.created_at) : new Date();
        const dKey = isNaN(created.getTime()) ? todayKey : created.toISOString().slice(0,10);

        const total = Number(o.total) || 0;
        salesByDay[dKey] = (salesByDay[dKey] || 0) + total;
        totalSum += total;
        if (dKey === todayKey) todayTotal += total;

        let items = [];
        try{ items = Array.isArray(o.items) ? o.items : JSON.parse(o.items || "[]"); }
        catch(e){ items = []; }

        items.forEach(it => {
          const name = (it.food || '').trim();
          const qty = Number(it.qty) || 1;

          if (name) menuCount[name] = (menuCount[name] || 0) + qty;

          const house = (o.house || '-').toString();
          houseCount[house] = (houseCount[house] || 0) + qty;

          for (const kw of meatKeywords) {
            if (name.indexOf(kw) !== -1) {
              meatCount[kw] = (meatCount[kw] || 0) + qty;
            }
          }
        });
      } catch(innerErr){
        console.warn("Skipping an order in aggregation due to error:", innerErr);
      }
    });

    /* --------- ‡∏Å‡∏£‡∏≤‡∏ü -------- */
    const labels = Object.keys(salesByDay).sort((a,b)=> new Date(a) - new Date(b));
    const chartData = labels.map(l => salesByDay[l] || 0);

    renderSalesChart(labels, chartData);

    /* --------- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -------- */
    const todaySalesEl = document.getElementById("todaySales");
    if (todaySalesEl) todaySalesEl.innerText = todayTotal.toLocaleString();

    /* --------- 5 ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î -------- */
    const topMenus = Object.entries(menuCount).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const topMenusTbody = document.querySelector('#topMenusTable tbody');

    if (topMenusTbody) {
      topMenusTbody.innerHTML = '';
      topMenus.forEach(([name,count])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="text-align:left">${name}</td>
                        <td style="text-align:right">${count}</td>`;
        topMenusTbody.appendChild(tr);
      });

      if (topMenus.length === 0) {
        topMenusTbody.innerHTML = `<tr><td colspan="2" style="text-align:center;color:#777;padding:12px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
      }
    }

    /* --------- ‡∏ö‡πâ‡∏≤‡∏ô/‡πÇ‡∏ï‡πä‡∏∞ ‡∏™‡∏±‡πà‡∏á‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î -------- */
    const topHouse = Object.entries(houseCount).sort((a,b)=>b[1]-a[1])[0];
    const topHouseEl = document.getElementById('topHouse');
    if (topHouseEl) {
      topHouseEl.innerText = topHouse ? `${topHouse[0]} (${topHouse[1]} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)` : '-';
    }

    /* --------- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î -------- */
    const topMeat = Object.entries(meatCount).sort((a,b)=>b[1]-a[1])[0];
    const topMeatEl = document.getElementById('topMeat');
    if (topMeatEl) {
      topMeatEl.innerText = topMeat ? `${topMeat[0]} (${topMeat[1]})` : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞';
    }

    /* --------- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° -------- */
    const sumTotalEl = document.getElementById('sumTotal');
    if (sumTotalEl) sumTotalEl.innerText = totalSum.toLocaleString();

  } catch(e){
    console.error("loadDashboard err", e);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡πÇ‡∏´‡∏•‡∏î dashboard");
  }
}

/* --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏µ‡∏ö‡∏±‡πä‡∏Å (‡πÉ‡∏™‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÑ‡∏î‡πâ) --- */
window.onerror = function(message, source, lineno, colno, error) {
  console.error("Global error:", message, "at", source + ":" + lineno + ":" + colno, error);
  // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á alert ‡πÄ‡∏™‡∏°‡∏≠ ‚Äî ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏î‡∏µ‡∏ö‡∏±‡∏Å‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ
  alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin (‡∏î‡∏π console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)");
};

/* --- ‡πÅ‡∏Å‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏ô switchTab ‡πÄ‡∏û‡∏∑‡πà‡∏≠ log --- */
function switchTab(tab){
  try {
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    const el = document.getElementById(tab);
    if(el) el.classList.add("active");

    // set active link
    if(tab === 'dashboardSec') setActiveTab("tab-dashboard");
    if(tab === 'orderSec') setActiveTab("tab-order");
    if(tab === 'menuSec') setActiveTab("tab-menu");
    if(tab === 'optSec') setActiveTab("tab-opt");
    if(tab === 'settingsSec') setActiveTab("tab-settings");

    // set page title
    if(tab === 'dashboardSec') updatePageTitle("Dashboard");
    if(tab === 'orderSec') updatePageTitle("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå");
    if(tab === 'menuSec') updatePageTitle("‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π");
    if(tab === 'optSec') updatePageTitle("‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
    if(tab === 'settingsSec') updatePageTitle("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô");

    // loaders
    if(tab === 'orderSec'){ loadOrders().catch(e=>console.error(e)); }
    if(tab === 'menuSec'){ loadMenus().catch(e=>console.error(e)); }
    if(tab === 'optSec'){ loadOptions().catch(e=>console.error(e)); }
    if(tab === 'dashboardSec'){
      const to = new Date();
      const from = new Date(to.getFullYear(), to.getMonth(), to.getDate()-6);
      if(document.getElementById('dashFrom')) document.getElementById('dashFrom').value = from.toISOString().slice(0,10);
      if(document.getElementById('dashTo')) document.getElementById('dashTo').value = to.toISOString().slice(0,10);
      loadDashboard().catch(e=>console.error(e));
    }
    if(tab === 'settingsSec'){ loadStoreSettings().catch(e=>console.error(e)); }
  } catch(err){
    console.error("switchTab error:", err);
  }
}

    async function initAdmin() {
      try {
        // UI
        setActiveTab("tab-dashboard");
        switchTab("dashboardSec");

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        await loadOptionMap();      // ‚≠ê ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
        await loadMenus();
        await loadOptions();

        // ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏´‡∏•‡∏±‡∏á optionMap ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß)
        await loadOrders();

        // realtime + brand
        subscribeRealtime();
        await loadBrandUI();
        await loadShopStatus();
        bindShopSwitch();

      } catch (e) {
        console.error("initAdmin error:", e);
      }
    }

    window.addEventListener("load", initAdmin);

</script>
</body>
</html>
